<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deployment Notification Generator</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 750px; margin: auto; }
  label, select, input { display: block; margin: 10px 0; width: 100%; padding: 8px; }
  button { padding: 10px 15px; margin-top: 15px; cursor: pointer; }
  #output { white-space: pre-wrap; background: #f4f4f4; padding: 15px; margin-top: 20px; border: 1px solid #ccc; }
  .inline-group { display: flex; gap: 10px; }
  .inline-group select, .inline-group input { flex: 1; }
  input::placeholder { color: #999; }
  .disabled { background: #eee; }
</style>
</head>
<body>

<h2>Deployment Notification Generator</h2>

<label for="app">Affected System/Application:</label>
<select id="app" onchange="loadEmails()">
  <option value="">-- Select Application --</option>
  <option value="Alarm Manager">Alarm Manager</option>
  <option value="Altaia">Altaia</option>
  <option value="Altice Agora">Altice Agora</option>
  <option value="Analytics">Analytics</option>
  <option value="FF1">FF1</option>
  <option value="FFWK">FFWK</option>
  <option value="IAM">IAM</option>
  <option value="NOSSIS Common">NOSSIS Common</option>
  <option value="NetQ">NetQ</option>
  <option value="Netwin">Netwin</option>
  <option value="Nokia AMS">Nokia AMS</option>
  <option value="SIGO WO">SIGO WO</option>
  <option value="SIGO TTK">SIGO TTK</option>
  <option value="SIGO WOv15">SIGO WOv15</option>
</select>
<p id="emailCount"></p>

<label for="env">Environment:</label>
<select id="env">
  <option value="">-- Select Environment --</option>
  <option value="Production">Production</option>
  <option value="Test">Test</option>
  <option value="Pre-Production">Pre-Production</option>
</select>

<label for="date">Deployment Date:</label>
<input type="date" id="date">

<label for="time">Deployment Time:</label>
<input type="time" id="time">

<label for="downtime">Expected Downtime Duration:</label>
<div class="inline-group">
  <select id="downtime" onchange="toggleCustomDowntime()">
    <option value="">-- Select Duration --</option>
    <option value="5 minutes">5 minutes</option>
    <option value="10 minutes">10 minutes</option>
    <option value="15 minutes">15 minutes</option>
    <option value="30 minutes">30 minutes</option>
    <option value="45 minutes">45 minutes</option>
    <option value="1 hour">1 hour</option>
    <option value="2 hours">2 hours</option>
    <option value="Other">Other</option>
  </select>
  <input type="text" id="customDowntime" placeholder="Enter downtime" disabled class="disabled">
</div>

<label for="release">Vendor Release Notes / Version:</label>
<input type="text" id="release" placeholder="Anything can be entered here">

<button onclick="previewEmail()">Preview Email</button>

<div id="output"></div>

<script>
let emailList = [];

function validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

// Load emails from Excel based on selected app
async function loadEmails() {
  const app = document.getElementById("app").value.trim();
  emailList = [];
  document.getElementById("emailCount").textContent = "";
  if (!app) return;

  try {
    const fileName = `users/${app}.xlsx`;
    const response = await fetch(fileName);
    if (!response.ok) { alert(`No email list found for ${app}`); return; }

    const data = await response.arrayBuffer();
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    emailList = rows.map(row => row.Email || row.email || row.EMAIL)
                    .filter(e => e && validateEmail(e));
    document.getElementById("emailCount").textContent = `${emailList.length} email(s) will be notified.`;
  } catch(err) { console.error(err); alert("Error loading email list."); }
}

function toggleCustomDowntime() {
  const downtime = document.getElementById("downtime").value;
  const custom = document.getElementById("customDowntime");
  if (downtime === "Other") { custom.disabled=false; custom.classList.remove("disabled"); }
  else { custom.disabled=true; custom.value=""; custom.classList.add("disabled"); }
}

function toTitleCase(str) { return str.replace(/\w\S*/g, txt => txt.charAt(0).toUpperCase() + txt.slice(1).toLowerCase()); }

function parseDowntime(downtime) {
  const lower = downtime.toLowerCase();
  if (lower.includes("hour")) return parseFloat(lower)*60;
  if (lower.includes("minute")) return parseFloat(lower);
  return 0;
}

// Prefill from URL query parameters
function getQueryParams() {
  const params={};
  const qs = window.location.search.substring(1);
  qs.split("&").forEach(pair => {
    const [k,v] = pair.split("=");
    if(k) params[k] = decodeURIComponent(v.replace(/\+/g," "));
  });
  return params;
}
function prefillFields() {
  const p = getQueryParams();
  if(p.app) document.getElementById("app").value = p.app;
  if(p.env) document.getElementById("env").value = p.env;
  if(p.date) document.getElementById("date").value = p.date;
  if(p.time) document.getElementById("time").value = p.time;
  if(p.downtime) {
    const downtimeSelect = document.getElementById("downtime");
    const customInput = document.getElementById("customDowntime");
    if(["5 minutes","10 minutes","15 minutes","30 minutes","45 minutes","1 hour","2 hours"].includes(p.downtime)){
      downtimeSelect.value = p.downtime; customInput.value=""; customInput.disabled=true; customInput.classList.add("disabled");
    } else {
      downtimeSelect.value = "Other"; customInput.value=p.downtime; customInput.disabled=false; customInput.classList.remove("disabled");
    }
  }
  if(p.release) document.getElementById("release").value = p.release;
}

window.addEventListener("DOMContentLoaded", prefillFields);

// Preview and generate mailto
function previewEmail() {
  const appRaw=document.getElementById("app").value.trim();
  const capitalizedApp=toTitleCase(appRaw);
  const env=document.getElementById("env").value.trim();
  const date=document.getElementById("date").value;
  const time=document.getElementById("time").value;
  const downtime=document.getElementById("downtime").value==="Other"
      ? document.getElementById("customDowntime").value.trim()
      : document.getElementById("downtime").value.trim();
  const release=document.getElementById("release").value.trim()||"N/A";

  if(!capitalizedApp||!env||!date||!time||!downtime) { alert("Please fill all required fields."); return; }
  if(emailList.length===0) { alert("Email list empty."); return; }

  const selectedDT=new Date(`${date}T${time}`); const now=new Date();
  if(env==="Production" && selectedDT<now){ alert("Production deployment must be present or future."); return; }
  if((env==="Test"||env==="Pre-Production") && selectedDT<new Date(now.getTime()-5*60*1000)){
    alert("Test/Pre-Production deployment too far in past."); return;
  }

  const dtMin=parseDowntime(downtime);
  const availableDT=new Date(selectedDT.getTime()+dtMin*60000);
  const fDate=selectedDT.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'});
  const fTime=selectedDT.toLocaleTimeString("en-US",{hour:'numeric',minute:'2-digit',hour12:true})+" CEST";
  const fAvailableTime=availableDT.toLocaleTimeString("en-US",{hour:'numeric',minute:'2-digit',hour12:true})+" CEST";

  const subject=`[REMINDER] Software Installation on ${fDate} â€“ ${env}`;

  const bodyText=
`Dear Sir or Madam,

We would like to inform you about an upcoming software installation as part of our regular maintenance and development measures.

Affected Systems/Applications:  ${capitalizedApp}
Environment:                   ${env}
Scheduled Installation:        ${fDate} at ${fTime}
Expected Downtime:             ${downtime}
Vendor Release Notes:           ${release}

Please note that you will only be able to use ${capitalizedApp} from ${fAvailableTime} on that day.

We will, of course, make every effort to minimize any potential disruptions.

Thank you for your understanding.
Best regards,`;

  const mailto=`mailto:?bcc=${encodeURIComponent(emailList.join(","))}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}`;

  document.getElementById("output").innerHTML=
  `<b>Subject:</b> ${subject}<br><br>
   <b>Email Preview:</b><br><pre>${bodyText}</pre><br>
   <b>Recipients:</b> ${emailList.length} (in BCC)<br><br>
   <button onclick="window.location.href='${mailto}'">Open in Outlook</button>`;
}
</script>

</body>
</html>
